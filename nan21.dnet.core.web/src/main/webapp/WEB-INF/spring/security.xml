<beans xmlns:security="http://www.springframework.org/schema/security"
	xmlns="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:osgi="http://www.springframework.org/schema/osgi"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/security
           http://www.springframework.org/schema/security/spring-security.xsd
           http://www.springframework.org/schema/osgi 
		http://www.springframework.org/schema/osgi/spring-osgi.xsd">
  
	<security:http auto-config="true" entry-point-ref="defaultAuthenticationEntryPoint" >
		<security:access-denied-handler ref="accessDeniedHandler" />
		
		<security:intercept-url pattern="/tx/**" access="ROLE_DNET_USER" />
		<security:intercept-url pattern="/upload/**" access="ROLE_DNET_USER" />
		<security:intercept-url pattern="/security/*" filters="none" />
		 			
	</security:http>
 
	<security:authentication-manager  alias="authenticationManager" >
		 <security:authentication-provider user-service-ref="defaultAuthenticationDbUserService" /> 		 	 	 
	</security:authentication-manager>
 	 
 	<bean name="accessDeniedHandler"
		class="net.nan21.dnet.core.security.DefaultAccessDeniedHandler" />
	<bean name="defaultAuthenticationEntryPoint"
		class="net.nan21.dnet.core.security.DefaultNotAuthenticatedEntryPoint" />
  
 	<bean name="defaultAuthenticationDbUserService"
		class="net.nan21.dnet.core.security.DbUserService">
		<property name="usersByUsernameQuery"
			value="select u.code, u.name, u.password, u.active, 0 accountExpired, 0 credentialsExpired,0 accountLocked, u.clientid clientId, c.code clientCode, 
			c.defaultDsAccessRule, c.defaultImportPath, c.defaultExportPath, c.tempPath, c.adminRole, c.systemClient, '', 0, 
					f.extjsDateFormat, f.extjsTimeFormat, f.extjsDateTimeFormat, f.extjsAltFormats,	f.javaDateFormat, f.javaTimeFormat, f.javaDateTimeFormat ,
					 u.decimalseparator, u.thousandseparator, asg.name asgnName, asg.id asgnId
				  from AD_USR u join AD_CLIENT c on u.clientid = c.id left join AD_SYS_DTFMT f on u.dateformat_id = f.id
				  left join AD_ASGNBL asg on u.code = asg.usercode
				where u.code = ? and c.code = ?" />
		<property name="authoritiesByUsernameQuery"
			value="select u.code , r.name 
				  from AD_USR_ROLE ur, AD_ROLE r, AD_USR u, AD_CLIENT c 
				where ur.users_id = u.id and ur.roles_id = r.id and u.clientid = c.id and u.code = ? and c.code = ?" />
		<property name="dataSource" ref="osgiDataSource" />
	</bean>
 
  	<osgi:reference id="osgiDataSource" cardinality="0..1"
		interface="javax.sql.DataSource" />
	
	
	<bean class="net.nan21.dnet.core.security.ChangeDbPasswordService" scope="request">  
		<property name="dataSource" ref="osgiDataSource"></property>
		<property name="sql" value="update AD_USR set password = ? where code = ? and clientid = ?"></property>
	</bean>	
</beans>